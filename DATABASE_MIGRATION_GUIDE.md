# 数据库迁移管理指南

## 📋 概述

本指南说明如何使用Alembic管理企业官网项目的数据库变更，实现数据库结构的版本控制和自动化部署。

## 🎯 核心原则

### ✅ 正确的做法
1. **创建迁移文件** - 修改数据库结构时，创建新的迁移文件
2. **提交到Git** - 将迁移文件提交到版本控制系统
3. **自动执行** - 在部署流程中自动运行迁移命令
4. **版本同步** - 数据库结构与代码版本保持同步

### ❌ 避免的做法
1. **直接操作数据库** - 不要直接在数据库中修改结构
2. **手动执行SQL** - 不要手动执行DDL语句
3. **跳过迁移** - 不要跳过迁移步骤
4. **混合环境** - 不要在不同环境使用不同的数据库结构

## 🏗️ 系统架构

### 迁移工具
- **Alembic**: Python数据库迁移工具
- **SQLAlchemy**: ORM框架，用于模型定义
- **Docker**: 容器化部署，确保环境一致性

### 文件结构
```
enterprise-backend/
├── alembic.ini                    # Alembic配置文件
├── migrate.py                     # 迁移管理脚本
├── migrations/                    # 迁移文件目录
│   ├── env.py                     # Alembic环境配置
│   ├── script.py.mako             # 迁移文件模板
│   └── versions/                  # 迁移版本文件
│       ├── 0001_initial_migration.py
│       ├── 0002_add_user_table.py
│       └── ...
└── app/
    ├── models.py                  # 数据库模型定义
    └── database.py                # 数据库连接配置
```

## 🚀 快速开始

### 1. 初始化迁移环境

```bash
# 开发环境
./migrate.sh dev init

# 测试环境
./migrate.sh test init

# 生产环境
./migrate.sh prod init
```

### 2. 创建迁移文件

```bash
# 创建新的迁移文件
./migrate.sh dev create "添加用户表"
./migrate.sh dev create "修改产品表结构"
./migrate.sh dev create "添加索引优化查询"
```

### 3. 执行迁移

```bash
# 升级到最新版本
./migrate.sh dev upgrade
./migrate.sh test upgrade
./migrate.sh prod upgrade

# 升级到指定版本
./migrate.sh dev upgrade 0003
```

### 4. 查看迁移状态

```bash
# 查看当前版本
./migrate.sh dev current

# 查看迁移历史
./migrate.sh dev history

# 查看待执行迁移
./migrate.sh dev pending
```

## 🔄 工作流程

### 开发阶段

#### 1. 修改模型
```python
# app/models.py
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    # 添加新字段
    phone = Column(String(20), nullable=True)  # 新增字段
    created_at = Column(DateTime, default=datetime.now)
```

#### 2. 生成迁移文件
```bash
./migrate.sh dev create "添加用户手机号字段"
```

#### 3. 检查迁移文件
```python
# migrations/versions/0004_add_user_phone.py
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('phone', sa.String(length=20), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'phone')
    # ### end Alembic commands ###
```

#### 4. 测试迁移
```bash
# 执行迁移
./migrate.sh dev upgrade

# 验证结果
./migrate.sh dev current
```

#### 5. 提交到Git
```bash
git add migrations/versions/0004_add_user_phone.py
git commit -m "feat: 添加用户手机号字段"
git push
```

### 测试阶段

#### 1. 部署到测试环境
```bash
# 设置测试环境变量
source ./set_env.sh test

# 部署并自动运行迁移
./deploy.sh test up
```

#### 2. 验证迁移结果
```bash
# 检查迁移状态
./deploy.sh test migrate-check

# 运行测试
# 确保所有功能正常
```

### 生产阶段

#### 1. 部署到生产环境
```bash
# 设置生产环境变量
export PROD_DATABASE_URL="mysql+pymysql://user:password@host:port/database"
source ./set_env.sh prod

# 部署并自动运行迁移
./deploy.sh prod up
```

#### 2. 监控迁移结果
```bash
# 检查迁移状态
./deploy.sh prod migrate-check

# 监控应用日志
./deploy.sh prod logs
```

## 🛠️ 常用命令

### 迁移管理

```bash
# 创建迁移文件
./migrate.sh [env] create "迁移描述"

# 执行迁移
./migrate.sh [env] upgrade [revision]

# 回滚迁移
./migrate.sh [env] downgrade [revision]

# 查看状态
./migrate.sh [env] current
./migrate.sh [env] history
./migrate.sh [env] pending
```

### Docker部署

```bash
# 部署并自动迁移
./deploy.sh [env] up

# 手动运行迁移
./deploy.sh [env] migrate

# 检查迁移状态
./deploy.sh [env] migrate-check
```

## 🔧 高级用法

### 1. 自定义迁移脚本

```python
# migrations/versions/0005_custom_migration.py
def upgrade() -> None:
    # 自定义SQL
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")
    
    # 添加索引
    op.create_index('idx_user_email', 'users', ['email'])
    
    # 修改列类型
    op.alter_column('users', 'phone', type_=String(15))

def downgrade() -> None:
    op.drop_index('idx_user_email', 'users')
    op.alter_column('users', 'phone', type_=String(20))
```

### 2. 数据迁移

```python
# migrations/versions/0006_data_migration.py
from sqlalchemy import text

def upgrade() -> None:
    # 获取数据库连接
    connection = op.get_bind()
    
    # 执行数据迁移
    connection.execute(text("""
        UPDATE products 
        SET category_id = (
            SELECT id FROM categories 
            WHERE name = '默认分类'
        ) 
        WHERE category_id IS NULL
    """))

def downgrade() -> None:
    # 回滚数据迁移
    connection = op.get_bind()
    connection.execute(text("UPDATE products SET category_id = NULL"))
```

### 3. 条件迁移

```python
# migrations/versions/0007_conditional_migration.py
def upgrade() -> None:
    # 检查表是否存在
    if op.get_bind().dialect.has_table(op.get_bind(), 'old_table'):
        # 执行迁移
        op.rename_table('old_table', 'new_table')

def downgrade() -> None:
    if op.get_bind().dialect.has_table(op.get_bind(), 'new_table'):
        op.rename_table('new_table', 'old_table')
```

## 🚨 故障排除

### 常见问题

#### 1. 迁移失败
```bash
# 查看详细错误信息
./migrate.sh [env] upgrade --verbose

# 检查数据库连接
./migrate.sh [env] current

# 手动修复后继续
./migrate.sh [env] upgrade
```

#### 2. 版本冲突
```bash
# 查看迁移历史
./migrate.sh [env] history

# 手动设置版本
./migrate.sh [env] stamp [revision]

# 重新执行迁移
./migrate.sh [env] upgrade
```

#### 3. 数据丢失
```bash
# 立即停止服务
./deploy.sh [env] down

# 从备份恢复
# 然后重新执行迁移
./deploy.sh [env] up
```

### 紧急回滚

```bash
# 回滚到上一个版本
./migrate.sh [env] downgrade -1

# 回滚到指定版本
./migrate.sh [env] downgrade [revision]

# 回滚到基础版本（危险）
./migrate.sh [env] reset
```

## 📊 最佳实践

### 1. 迁移文件命名
- 使用描述性的名称
- 包含版本号和功能描述
- 例如: `0001_initial_migration.py`, `0002_add_user_table.py`

### 2. 迁移内容
- 每次迁移只做一件事
- 包含回滚逻辑
- 测试迁移和回滚

### 3. 部署流程
- 先在开发环境测试
- 然后在测试环境验证
- 最后部署到生产环境

### 4. 备份策略
- 生产环境迁移前备份
- 保留多个版本的备份
- 定期测试备份恢复

## 🔒 安全注意事项

### 1. 生产环境
- 迁移前必须备份数据库
- 在维护窗口执行迁移
- 监控迁移执行过程

### 2. 权限管理
- 限制迁移执行权限
- 使用专用数据库用户
- 记录所有迁移操作

### 3. 数据保护
- 敏感数据加密存储
- 迁移过程中保护数据
- 验证迁移结果

## 📞 技术支持

如有问题，请参考：
1. 本迁移指南
2. Alembic官方文档
3. SQLAlchemy文档
4. 联系开发团队

---

**🎯 记住：数据库迁移是数据库结构变更的唯一正确方式！**
