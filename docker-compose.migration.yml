# æ•°æ®åº“è¿ç§»æœåŠ¡é…ç½®
# ç”¨äºåœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»

version: '3.8'

services:
  # æ•°æ®åº“è¿ç§»æœåŠ¡
  migration:
    build:
      context: ./enterprise-backend
      dockerfile: Dockerfile
    container_name: enterprise_migration
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
    command: >
      sh -c "
        echo 'ğŸ”„ ç­‰å¾…æ•°æ®åº“å¯åŠ¨...' &&
        sleep 10 &&
        echo 'ğŸ“ è¿è¡Œæ•°æ®åº“è¿ç§»...' &&
        python migrate.py upgrade head &&
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆ'
      "
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - enterprise_network
    restart: "no"  # è¿ç§»å®Œæˆåä¸é‡å¯

  # æ•°æ®åº“è¿ç§»æ£€æŸ¥æœåŠ¡
  migration-check:
    build:
      context: ./enterprise-backend
      dockerfile: Dockerfile
    container_name: enterprise_migration_check
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
    command: >
      sh -c "
        echo 'ğŸ” æ£€æŸ¥æ•°æ®åº“è¿ç§»çŠ¶æ€...' &&
        python migrate.py current &&
        echo 'ğŸ“‹ æ˜¾ç¤ºè¿ç§»å†å²...' &&
        python migrate.py history
      "
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - enterprise_network
    restart: "no"  # æ£€æŸ¥å®Œæˆåä¸é‡å¯
