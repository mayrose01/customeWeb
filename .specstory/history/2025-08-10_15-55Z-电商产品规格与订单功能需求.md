<!-- Generated by SpecStory -->

# 电商产品规格与订单功能需求 (2025-08-10 15:55Z)

_**User**_

我想把我现在的产品改成，可以新增产品规格，修改规格，删除规格，多层规格，然后可以填写对应规格的价格，库存，客户端可以显示价格，可以加入购物车或者直接购买，提交订单后可以微信支付或者支付宝支付。支付成功跳转到我的订单页面。嗯，把之前我的询价改成我的订单。订单在后台可以发货，更新物流信息等类似电商的那种订单功能。

---

_**Assistant**_

我理解您想要将现有的产品系统改造成一个完整的电商系统，包括产品规格管理、购物车、订单管理和支付功能。让我先了解一下现有的代码结构，然后为您实现这些功能。


---

<details>
                <summary>Searched codebase "product model schema database" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `enterprise-backend/app/models.py` | L24-35 |
| `enterprise-backend/app/api/endpoints/category.py` | L30-41 |
| `enterprise-backend/app/schemas.py` | L37-47 |
| `enterprise-backend/app/schemas.py` | L50-55 |
| `enterprise-backend/app/crud.py` | L67-74 |
| `enterprise-backend/app/models.py` | L35-44 |
| `enterprise-backend/app/models.py` | L1-17 |
| `enterprise-backend/app/api/endpoints/product.py` | L18-22 |
| `enterprise-backend/app/schemas.py` | L47-50 |
| `enterprise-backend/app/api/endpoints/product.py` | L1-14 |
| `enterprise-backend/app/crud.py` | L62-67 |
| `enterprise-backend/app/api/endpoints/product.py` | L22-29 |
| `enterprise-backend/app/crud.py` | L74-77 |
| `enterprise-backend/app/api/endpoints/product.py` | L14-18 |
| `enterprise-frontend/src/views/ProductManage.vue` | L1-51 |

</details>

---

Read file: enterprise-backend/app/models.py

---

Read file: enterprise-backend/app/schemas.py

---

现在我来为您实现完整的电商系统功能。我将按照以下步骤进行：

1. 首先更新数据库模型，添加产品规格、购物车、订单等表
2. 更新API接口
3. 更新前端页面

让我开始实现：

## 1. 更新数据库模型


---

Tool call timed out after 200s (edit file)

---

让我重新编辑文件：


---

The string to replace was not found in the file.

---

Read file: enterprise-backend/app/models.py

---

很好！看起来模型文件已经被更新了。现在让我更新schemas.py文件来支持新的电商功能：


---

<details><summary>Edit file: enterprise-backend/app/schemas.py</summary>

我将在现有schemas基础上添加电商系统所需的新schema，包括产品规格、SKU、购物车、订单等

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -2,4 +2,5 @@
  from typing import Optional, List
  from datetime import datetime
+ from decimal import Decimal
  
  class CompanyInfoBase(BaseModel):
```

**Chunk 2**
Lines added: 60, lines removed: undefined

```diff
@@ -44,4 +45,64 @@
          from_attributes = True
  
+ # 产品规格相关schema
+ class ProductSpecificationBase(BaseModel):
+     name: str
+     parent_id: Optional[int] = None
+     sort_order: Optional[int] = 0
+ 
+ class ProductSpecificationCreate(ProductSpecificationBase):
+     product_id: int
+ 
+ class ProductSpecificationUpdate(ProductSpecificationBase):
+     pass
+ 
+ class ProductSpecificationOut(ProductSpecificationBase):
+     id: int
+     product_id: int
+     class Config:
+         from_attributes = True
+ 
+ class ProductSpecificationValueBase(BaseModel):
+     value: str
+     sort_order: Optional[int] = 0
+ 
+ class ProductSpecificationValueCreate(ProductSpecificationValueBase):
+     specification_id: int
+ 
+ class ProductSpecificationValueUpdate(ProductSpecificationValueBase):
+     pass
+ 
+ class ProductSpecificationValueOut(ProductSpecificationValueBase):
+     id: int
+     specification_id: int
+     class Config:
+         from_attributes = True
+ 
+ class ProductSpecificationWithValues(ProductSpecificationOut):
+     values: List[ProductSpecificationValueOut] = []
+ 
+ # SKU相关schema
+ class ProductSKUBase(BaseModel):
+     sku_code: str
+     price: Decimal
+     stock: int
+     is_active: Optional[bool] = True
+ 
+ class ProductSKUCreate(ProductSKUBase):
+     product_id: int
+     specifications: List[int] = []  # 规格值ID列表
+ 
+ class ProductSKUUpdate(ProductSKUBase):
+     pass
+ 
+ class ProductSKUOut(ProductSKUBase):
+     id: int
+     product_id: int
+     created_at: datetime
+     updated_at: datetime
+     class Config:
+         from_attributes = True
+ 
+ # 更新产品schema
  class ProductBase(BaseModel):
      title: str
```

**Chunk 3**
Lines added: 2, lines removed: undefined

```diff
@@ -51,4 +112,6 @@
      images: Optional[List[str]] = []  # 多张图片URL数组，最多5张
      category_id: int
+     base_price: Optional[Decimal] = 0.00
+     is_active: Optional[bool] = True
  
      @validator('images')
```

**Chunk 4**
Lines added: 4, lines removed: 2

```diff
@@ -59,8 +122,10 @@
  
  class ProductCreate(ProductBase):
-     pass
+     specifications: Optional[List[ProductSpecificationCreate]] = []
+     skus: Optional[List[ProductSKUCreate]] = []
  
  class ProductUpdate(ProductBase):
-     pass
+     specifications: Optional[List[ProductSpecificationCreate]] = []
+     skus: Optional[List[ProductSKUCreate]] = []
  
  class ProductOut(BaseModel):
```

**Chunk 5**
Lines added: 5, lines removed: 1

```diff
@@ -72,7 +137,11 @@
      images: Optional[List[str]]
      category_id: int
+     base_price: Optional[Decimal]
+     is_active: Optional[bool]
      created_at: datetime
      updated_at: datetime
-     category: Optional[CategoryOut]
+     category: Optional['CategoryOut']
+     specifications: List[ProductSpecificationWithValues] = []
+     skus: List[ProductSKUOut] = []
      class Config:
          from_attributes = True
```

**Chunk 6**
Lines added: 128, lines removed: undefined

```diff
@@ -322,2 +391,130 @@
      page_size: int
      total_pages: int 
+ 
+ # 购物车相关schema
+ class CartItemBase(BaseModel):
+     sku_id: int
+     quantity: int
+ 
+ class CartItemCreate(CartItemBase):
+     pass
+ 
+ class CartItemUpdate(BaseModel):
+     quantity: int
+ 
+ class CartItemOut(CartItemBase):
+     id: int
+     cart_id: int
+     created_at: datetime
+     updated_at: datetime
+     sku: ProductSKUOut
+     class Config:
+         from_attributes = True
+ 
+ class CartOut(BaseModel):
+     id: int
+     user_id: int
+     created_at: datetime
+     updated_at: datetime
+     items: List[CartItemOut] = []
+     class Config:
+         from_attributes = True
+ 
+ # 订单相关schema
+ class OrderItemBase(BaseModel):
+     sku_id: int
+     quantity: int
+     price: Decimal
+     specifications: Optional[dict] = {}
+ 
+ class OrderItemCreate(OrderItemBase):
+     pass
+ 
+ class OrderItemOut(OrderItemBase):
+     id: int
+     order_id: int
+     product_title: str
+     sku_code: str
+     subtotal: Decimal
+     class Config:
+         from_attributes = True
+ 
+ class OrderBase(BaseModel):
+     shipping_address: str
+     shipping_contact: str
+     shipping_phone: str
+     remark: Optional[str] = None
+ 
+ class OrderCreate(OrderBase):
+     items: List[OrderItemCreate]
+     payment_method: str
+ 
+ class OrderUpdate(BaseModel):
+     status: Optional[str] = None
+     shipping_company: Optional[str] = None
+     tracking_number: Optional[str] = None
+     shipping_time: Optional[datetime] = None
+     delivery_time: Optional[datetime] = None
+ 
+ class OrderOut(BaseModel):
+     id: int
+     order_no: str
+     user_id: int
+     status: str
+     total_amount: Decimal
+     payment_method: Optional[str]
+     payment_status: str
+     payment_time: Optional[datetime]
+     shipping_address: str
+     shipping_contact: str
+     shipping_phone: str
+     shipping_company: Optional[str]
+     tracking_number: Optional[str]
+     shipping_time: Optional[datetime]
+     delivery_time: Optional[datetime]
+     remark: Optional[str]
+     created_at: datetime
+     updated_at: datetime
+     items: List[OrderItemOut] = []
+     class Config:
+         from_attributes = True
+ 
+ class OrderListResponse(BaseModel):
+     items: List[OrderOut]
+     total: int
+     page: int
+     page_size: int
+     total_pages: int
+ 
+ # 支付相关schema
+ class PaymentRequest(BaseModel):
+     order_id: int
+     payment_method: str  # wechat, alipay
+ 
+ class PaymentResponse(BaseModel):
+     order_id: int
+     payment_url: str  # 支付链接
+     qr_code: Optional[str] = None  # 二维码（微信支付）
+ 
+ # 客户端产品展示schema
+ class ClientProductOut(BaseModel):
+     id: int
+     title: str
+     model: Optional[str]
+     short_desc: Optional[str]
+     images: Optional[List[str]]
+     category_id: int
+     base_price: Optional[Decimal]
+     min_price: Optional[Decimal]  # 最低价格
+     max_price: Optional[Decimal]  # 最高价格
+     has_stock: bool  # 是否有库存
+     specifications: List[ProductSpecificationWithValues] = []
+     class Config:
+         from_attributes = True
+ 
+ class ClientProductListResponse(BaseModel):
+     items: List[ClientProductOut]
+     total: int
+     page: int
+     page_size: int
+     total_pages: int 
```

</details>

---

现在让我更新CRUD操作文件：


---

Read file: enterprise-backend/app/crud.py

---

现在让我在CRUD文件中添加电商相关的操作：


---

<details><summary>Edit file: enterprise-backend/app/crud.py</summary>

我将在文件末尾添加电商系统所需的CRUD操作，包括产品规格、SKU、购物车、订单等管理功能

**Chunk 1**
Lines added: 370, lines removed: undefined

```diff
@@ -815,2 +815,372 @@
      logger.info(f"创建咨询记录: ID={message.id}, 用户ID={user_id}")
      return message 
+ 
+ # 电商系统相关CRUD操作
+ 
+ # 产品规格管理
+ def create_product_specification(db: Session, data: schemas.ProductSpecificationCreate) -> models.ProductSpecification:
+     spec = models.ProductSpecification(**data.dict())
+     db.add(spec)
+     db.commit()
+     db.refresh(spec)
+     logger.info(f"创建产品规格: ID={spec.id}, 名称={spec.name}, 产品ID={spec.product_id}")
+     return spec
+ 
+ def get_product_specifications(db: Session, product_id: int) -> List[models.ProductSpecification]:
+     return db.query(models.ProductSpecification).filter(
+         models.ProductSpecification.product_id == product_id
+     ).order_by(models.ProductSpecification.sort_order).all()
+ 
+ def update_product_specification(db: Session, spec_id: int, data: schemas.ProductSpecificationUpdate) -> Optional[models.ProductSpecification]:
+     spec = db.query(models.ProductSpecification).filter(models.ProductSpecification.id == spec_id).first()
+     if not spec:
+         return None
+     
+     for key, value in data.dict(exclude_unset=True).items():
+         setattr(spec, key, value)
+     
+     db.commit()
+     db.refresh(spec)
+     logger.info(f"更新产品规格: ID={spec_id}")
+     return spec
+ 
+ def delete_product_specification(db: Session, spec_id: int) -> bool:
+     spec = db.query(models.ProductSpecification).filter(models.ProductSpecification.id == spec_id).first()
+     if not spec:
+         return False
+     
+     db.delete(spec)
+     db.commit()
+     logger.info(f"删除产品规格: ID={spec_id}")
+     return True
+ 
+ # 产品规格值管理
+ def create_product_specification_value(db: Session, data: schemas.ProductSpecificationValueCreate) -> models.ProductSpecificationValue:
+     value = models.ProductSpecificationValue(**data.dict())
+     db.add(value)
+     db.commit()
+     db.refresh(value)
+     logger.info(f"创建规格值: ID={value.id}, 值={value.value}, 规格ID={value.specification_id}")
+     return value
+ 
+ def get_product_specification_values(db: Session, specification_id: int) -> List[models.ProductSpecificationValue]:
+     return db.query(models.ProductSpecificationValue).filter(
+         models.ProductSpecificationValue.specification_id == specification_id
+     ).order_by(models.ProductSpecificationValue.sort_order).all()
+ 
+ def update_product_specification_value(db: Session, value_id: int, data: schemas.ProductSpecificationValueUpdate) -> Optional[models.ProductSpecificationValue]:
+     value = db.query(models.ProductSpecificationValue).filter(models.ProductSpecificationValue.id == value_id).first()
+     if not value:
+         return None
+     
+     for key, value_data in data.dict(exclude_unset=True).items():
+         setattr(value, key, value_data)
+     
+     db.commit()
+     db.refresh(value)
+     logger.info(f"更新规格值: ID={value_id}")
+     return value
+ 
+ def delete_product_specification_value(db: Session, value_id: int) -> bool:
+     value = db.query(models.ProductSpecificationValue).filter(models.ProductSpecificationValue.id == value_id).first()
+     if not value:
+         return False
+     
+     db.delete(value)
+     db.commit()
+     logger.info(f"删除规格值: ID={value_id}")
+     return True
+ 
+ # SKU管理
+ def create_product_sku(db: Session, data: schemas.ProductSKUCreate) -> models.ProductSKU:
+     # 创建SKU
+     sku_data = data.dict(exclude={'specifications'})
+     sku = models.ProductSKU(**sku_data)
+     db.add(sku)
+     db.commit()
+     db.refresh(sku)
+     
+     # 创建SKU规格关联
+     for spec_value_id in data.specifications:
+         sku_spec = models.SKUSpecification(
+             sku_id=sku.id,
+             spec_value_id=spec_value_id
+         )
+         db.add(sku_spec)
+     
+     db.commit()
+     logger.info(f"创建产品SKU: ID={sku.id}, 编码={sku.sku_code}, 产品ID={sku.product_id}")
+     return sku
+ 
+ def get_product_skus(db: Session, product_id: int) -> List[models.ProductSKU]:
+     return db.query(models.ProductSKU).filter(
+         models.ProductSKU.product_id == product_id
+     ).all()
+ 
+ def update_product_sku(db: Session, sku_id: int, data: schemas.ProductSKUUpdate) -> Optional[models.ProductSKU]:
+     sku = db.query(models.ProductSKU).filter(models.ProductSKU.id == sku_id).first()
+     if not sku:
+         return None
+     
+     for key, value in data.dict(exclude_unset=True).items():
+         setattr(sku, key, value)
+     
+     db.commit()
+     db.refresh(sku)
+     logger.info(f"更新产品SKU: ID={sku_id}")
+     return sku
+ 
+ def delete_product_sku(db: Session, sku_id: int) -> bool:
+     sku = db.query(models.ProductSKU).filter(models.ProductSKU.id == sku_id).first()
+     if not sku:
+         return False
+     
+     db.delete(sku)
+     db.commit()
+     logger.info(f"删除产品SKU: ID={sku_id}")
+     return True
+ 
+ # 购物车管理
+ def get_or_create_cart(db: Session, user_id: int) -> models.Cart:
+     cart = db.query(models.Cart).filter(models.Cart.user_id == user_id).first()
+     if not cart:
+         cart = models.Cart(user_id=user_id)
+         db.add(cart)
+         db.commit()
+         db.refresh(cart)
+         logger.info(f"为用户创建购物车: 用户ID={user_id}")
+     return cart
+ 
+ def add_to_cart(db: Session, user_id: int, sku_id: int, quantity: int) -> models.CartItem:
+     cart = get_or_create_cart(db, user_id)
+     
+     # 检查是否已存在该SKU
+     existing_item = db.query(models.CartItem).filter(
+         models.CartItem.cart_id == cart.id,
+         models.CartItem.sku_id == sku_id
+     ).first()
+     
+     if existing_item:
+         existing_item.quantity += quantity
+         db.commit()
+         db.refresh(existing_item)
+         logger.info(f"更新购物车商品数量: 用户ID={user_id}, SKU ID={sku_id}, 新数量={existing_item.quantity}")
+         return existing_item
+     else:
+         cart_item = models.CartItem(
+             cart_id=cart.id,
+             sku_id=sku_id,
+             quantity=quantity
+         )
+         db.add(cart_item)
+         db.commit()
+         db.refresh(cart_item)
+         logger.info(f"添加商品到购物车: 用户ID={user_id}, SKU ID={sku_id}, 数量={quantity}")
+         return cart_item
+ 
+ def update_cart_item(db: Session, user_id: int, item_id: int, quantity: int) -> Optional[models.CartItem]:
+     cart = get_or_create_cart(db, user_id)
+     item = db.query(models.CartItem).filter(
+         models.CartItem.id == item_id,
+         models.CartItem.cart_id == cart.id
+     ).first()
+     
+     if not item:
+         return None
+     
+     item.quantity = quantity
+     db.commit()
+     db.refresh(item)
+     logger.info(f"更新购物车商品数量: 用户ID={user_id}, 商品ID={item_id}, 新数量={quantity}")
+     return item
+ 
+ def remove_from_cart(db: Session, user_id: int, item_id: int) -> bool:
+     cart = get_or_create_cart(db, user_id)
+     item = db.query(models.CartItem).filter(
+         models.CartItem.id == item_id,
+         models.CartItem.cart_id == cart.id
+     ).first()
+     
+     if not item:
+         return False
+     
+     db.delete(item)
+     db.commit()
+     logger.info(f"从购物车移除商品: 用户ID={user_id}, 商品ID={item_id}")
+     return True
+ 
+ def get_cart(db: Session, user_id: int) -> Optional[models.Cart]:
+     return db.query(models.Cart).filter(models.Cart.user_id == user_id).first()
+ 
+ def clear_cart(db: Session, user_id: int) -> bool:
+     cart = get_cart(db, user_id)
+     if not cart:
+         return False
+     
+     db.query(models.CartItem).filter(models.CartItem.cart_id == cart.id).delete()
+     db.commit()
+     logger.info(f"清空购物车: 用户ID={user_id}")
+     return True
+ 
+ # 订单管理
+ def create_order(db: Session, user_id: int, data: schemas.OrderCreate) -> models.Order:
+     # 生成订单号
+     import uuid
+     order_no = f"ORD{datetime.now().strftime('%Y%m%d')}{str(uuid.uuid4())[:8].upper()}"
+     
+     # 计算总金额
+     total_amount = 0
+     for item in data.items:
+         sku = db.query(models.ProductSKU).filter(models.ProductSKU.id == item.sku_id).first()
+         if sku:
+             total_amount += sku.price * item.quantity
+     
+     # 创建订单
+     order = models.Order(
+         order_no=order_no,
+         user_id=user_id,
+         total_amount=total_amount,
+         payment_method=data.payment_method,
+         shipping_address=data.shipping_address,
+         shipping_contact=data.shipping_contact,
+         shipping_phone=data.shipping_phone,
+         remark=data.remark
+     )
+     db.add(order)
+     db.commit()
+     db.refresh(order)
+     
+     # 创建订单项
+     for item in data.items:
+         sku = db.query(models.ProductSKU).filter(models.ProductSKU.id == item.sku_id).first()
+         if sku:
+             # 获取规格信息
+             sku_specs = db.query(models.SKUSpecification).filter(
+                 models.SKUSpecification.sku_id == item.sku_id
+             ).all()
+             
+             specifications = {}
+             for sku_spec in sku_specs:
+                 spec_value = db.query(models.ProductSpecificationValue).filter(
+                     models.ProductSpecificationValue.id == sku_spec.spec_value_id
+                 ).first()
+                 if spec_value:
+                     spec = db.query(models.ProductSpecification).filter(
+                         models.ProductSpecification.id == spec_value.specification_id
+                     ).first()
+                     if spec:
+                         specifications[spec.name] = spec_value.value
+             
+             order_item = models.OrderItem(
+                 order_id=order.id,
+                 sku_id=item.sku_id,
+                 product_title=sku.product.title,
+                 sku_code=sku.sku_code,
+                 price=sku.price,
+                 quantity=item.quantity,
+                 subtotal=sku.price * item.quantity,
+                 specifications=specifications
+             )
+             db.add(order_item)
+             
+             # 减少库存
+             sku.stock -= item.quantity
+     
+     db.commit()
+     logger.info(f"创建订单: 订单号={order_no}, 用户ID={user_id}, 总金额={total_amount}")
+     return order
+ 
+ def get_user_orders(db: Session, user_id: int, skip: int = 0, limit: int = 100) -> tuple[List[models.Order], int]:
+     total = db.query(models.Order).filter(models.Order.user_id == user_id).count()
+     orders = db.query(models.Order).filter(
+         models.Order.user_id == user_id
+     ).order_by(models.Order.created_at.desc()).offset(skip).limit(limit).all()
+     return orders, total
+ 
+ def get_order(db: Session, order_id: int) -> Optional[models.Order]:
+     return db.query(models.Order).filter(models.Order.id == order_id).first()
+ 
+ def get_order_by_no(db: Session, order_no: str) -> Optional[models.Order]:
+     return db.query(models.Order).filter(models.Order.order_no == order_no).first()
+ 
+ def update_order(db: Session, order_id: int, data: schemas.OrderUpdate) -> Optional[models.Order]:
+     order = get_order(db, order_id)
+     if not order:
+         return None
+     
+     for key, value in data.dict(exclude_unset=True).items():
+         setattr(order, key, value)
+     
+     db.commit()
+     db.refresh(order)
+     logger.info(f"更新订单: ID={order_id}")
+     return order
+ 
+ def get_all_orders(db: Session, skip: int = 0, limit: int = 100, status: Optional[str] = None) -> tuple[List[models.Order], int]:
+     query = db.query(models.Order)
+     if status:
+         query = query.filter(models.Order.status == status)
+     
+     total = query.count()
+     orders = query.order_by(models.Order.created_at.desc()).offset(skip).limit(limit).all()
+     return orders, total
+ 
+ # 支付相关
+ def update_payment_status(db: Session, order_id: int, payment_status: str, payment_time: Optional[datetime] = None) -> Optional[models.Order]:
+     order = get_order(db, order_id)
+     if not order:
+         return None
+     
+     order.payment_status = payment_status
+     if payment_time:
+         order.payment_time = payment_time
+     
+     if payment_status == "paid":
+         order.status = "paid"
+     
+     db.commit()
+     db.refresh(order)
+     logger.info(f"更新订单支付状态: 订单ID={order_id}, 状态={payment_status}")
+     return order
+ 
+ # 客户端产品展示
+ def get_client_products_with_specs(db: Session, category_id: Optional[int] = None, search: Optional[str] = None, 
+                                  skip: int = 0, limit: int = 100) -> tuple[List[models.Product], int]:
+     query = db.query(models.Product).filter(models.Product.is_active == True)
+     
+     if category_id:
+         query = query.filter(models.Product.category_id == category_id)
+     
+     if search:
+         search_filter = f"%{search}%"
+         query = query.filter(
+             models.Product.title.contains(search_filter) |
+             models.Product.model.contains(search_filter) |
+             models.Product.short_desc.contains(search_filter)
+         )
+     
+     total = query.count()
+     products = query.offset(skip).limit(limit).all()
+     
+     # 为每个产品添加规格和价格信息
+     for product in products:
+         # 获取最低和最高价格
+         skus = db.query(models.ProductSKU).filter(
+             models.ProductSKU.product_id == product.id,
+             models.ProductSKU.is_active == True
+         ).all()
+         
+         if skus:
+             prices = [sku.price for sku in skus]
+             product.min_price = min(prices)
+             product.max_price = max(prices)
+             product.has_stock = any(sku.stock > 0 for sku in skus)
+         else:
+             product.min_price = product.base_price
+             product.max_price = product.base_price
+             product.has_stock = False
+         
+         # 获取规格信息
+         product.specifications = get_product_specifications(db, product.id)
+     
+     return products, total 
```

</details>

---

现在让我创建新的API端点文件。首先创建产品规格管理的API：


---

<details><summary>Edit file: enterprise-backend/app/api/endpoints/specification.py</summary>

我将创建一个新的API端点文件来管理产品规格

**Chunk 1**
Lines added: 64, lines removed: 1

```diff
@@ -1,1 +1,64 @@
- 
+ from fastapi import APIRouter, Depends, HTTPException, Query
+ from sqlalchemy.orm import Session
+ from app import schemas, crud
+ from app.database import SessionLocal
+ from typing import List, Optional
+ 
+ router = APIRouter()
+ 
+ def get_db():
+     db = SessionLocal()
+     try:
+         yield db
+     finally:
+         db.close()
+ 
+ # 产品规格管理
+ @router.post("/", response_model=schemas.ProductSpecificationOut)
+ def create_specification(data: schemas.ProductSpecificationCreate, db: Session = Depends(get_db)):
+     spec = crud.create_product_specification(db, data)
+     return schemas.ProductSpecificationOut.model_validate(spec, from_attributes=True)
+ 
+ @router.get("/product/{product_id}", response_model=List[schemas.ProductSpecificationOut])
+ def get_product_specifications(product_id: int, db: Session = Depends(get_db)):
+     specs = crud.get_product_specifications(db, product_id)
+     return [schemas.ProductSpecificationOut.model_validate(spec, from_attributes=True) for spec in specs]
+ 
+ @router.put("/{spec_id}", response_model=schemas.ProductSpecificationOut)
+ def update_specification(spec_id: int, data: schemas.ProductSpecificationUpdate, db: Session = Depends(get_db)):
+     spec = crud.update_product_specification(db, spec_id, data)
+     if not spec:
+         raise HTTPException(status_code=404, detail="规格不存在")
+     return schemas.ProductSpecificationOut.model_validate(spec, from_attributes=True)
+ 
+ @router.delete("/{spec_id}")
+ def delete_specification(spec_id: int, db: Session = Depends(get_db)):
+     success = crud.delete_product_specification(db, spec_id)
+     if not success:
+         raise HTTPException(status_code=404, detail="规格不存在")
+     return {"message": "规格删除成功"}
+ 
+ # 规格值管理
+ @router.post("/values/", response_model=schemas.ProductSpecificationValueOut)
+ def create_specification_value(data: schemas.ProductSpecificationValueCreate, db: Session = Depends(get_db)):
+     value = crud.create_product_specification_value(db, data)
+     return schemas.ProductSpecificationValueOut.model_validate(value, from_attributes=True)
+ 
+ @router.get("/values/{specification_id}", response_model=List[schemas.ProductSpecificationValueOut])
+ def get_specification_values(specification_id: int, db: Session = Depends(get_db)):
+     values = crud.get_product_specification_values(db, specification_id)
+     return [schemas.ProductSpecificationValueOut.model_validate(value, from_attributes=True) for value in values]
+ 
+ @router.put("/values/{value_id}", response_model=schemas.ProductSpecificationValueOut)
+ def update_specification_value(value_id: int, data: schemas.ProductSpecificationValueUpdate, db: Session = Depends(get_db)):
+     value = crud.update_product_specification_value(db, value_id, data)
+     if not value:
+         raise HTTPException(status_code=404, detail="规格值不存在")
+     return schemas.ProductSpecificationValueOut.model_validate(value, from_attributes=True)
+ 
+ @router.delete("/values/{value_id}")
+ def delete_specification_value(value_id: int, db: Session = Depends(get_db)):
+     success = crud.delete_product_specification_value(db, value_id)
+     if not success:
+         raise HTTPException(status_code=404, detail="规格值不存在")
+     return {"message": "规格值删除成功"} 
```

</details>

---

现在创建SKU管理的API：


---

<details><summary>Edit file: enterprise-backend/app/api/endpoints/sku.py</summary>

我将创建一个新的API端点文件来管理产品SKU

**Chunk 1**
Lines added: 46, lines removed: 1

```diff
@@ -1,1 +1,46 @@
- 
+ from fastapi import APIRouter, Depends, HTTPException, Query
+ from sqlalchemy.orm import Session
+ from app import schemas, crud
+ from app.database import SessionLocal
+ from typing import List, Optional
+ 
+ router = APIRouter()
+ 
+ def get_db():
+     db = SessionLocal()
+     try:
+         yield db
+     finally:
+         db.close()
+ 
+ # SKU管理
+ @router.post("/", response_model=schemas.ProductSKUOut)
+ def create_sku(data: schemas.ProductSKUCreate, db: Session = Depends(get_db)):
+     sku = crud.create_product_sku(db, data)
+     return schemas.ProductSKUOut.model_validate(sku, from_attributes=True)
+ 
+ @router.get("/product/{product_id}", response_model=List[schemas.ProductSKUOut])
+ def get_product_skus(product_id: int, db: Session = Depends(get_db)):
+     skus = crud.get_product_skus(db, product_id)
+     return [schemas.ProductSKUOut.model_validate(sku, from_attributes=True) for sku in skus]
+ 
+ @router.put("/{sku_id}", response_model=schemas.ProductSKUOut)
+ def update_sku(sku_id: int, data: schemas.ProductSKUUpdate, db: Session = Depends(get_db)):
+     sku = crud.update_product_sku(db, sku_id, data)
+     if not sku:
+         raise HTTPException(status_code=404, detail="SKU不存在")
+     return schemas.ProductSKUOut.model_validate(sku, from_attributes=True)
+ 
+ @router.delete("/{sku_id}")
+ def delete_sku(sku_id: int, db: Session = Depends(get_db)):
+     success = crud.delete_product_sku(db, sku_id)
+     if not success:
+         raise HTTPException(status_code=404, detail="SKU不存在")
+     return {"message": "SKU删除成功"}
+ 
+ @router.get("/{sku_id}", response_model=schemas.ProductSKUOut)
+ def get_sku(sku_id: int, db: Session = Depends(get_db)):
+     sku = crud.get_product_sku(db, sku_id)
+     if not sku:
+         raise HTTPException(status_code=404, detail="SKU不存在")
+     return schemas.ProductSKUOut.model_validate(sku, from_attributes=True) 
```

</details>

---

现在创建购物车管理的API：


---

<details><summary>Edit file: enterprise-backend/app/api/endpoints/cart.py</summary>

我将创建一个新的API端点文件来管理购物车

**Chunk 1**
Lines added: 48, lines removed: 1

```diff
@@ -1,1 +1,48 @@
- 
+ from fastapi import APIRouter, Depends, HTTPException, Query
+ from sqlalchemy.orm import Session
+ from app import schemas, crud
+ from app.database import SessionLocal
+ from typing import List, Optional
+ 
+ router = APIRouter()
+ 
+ def get_db():
+     db = SessionLocal()
+     try:
+         yield db
+     finally:
+         db.close()
+ 
+ # 购物车管理
+ @router.get("/", response_model=schemas.CartOut)
+ def get_cart(user_id: int, db: Session = Depends(get_db)):
+     cart = crud.get_cart(db, user_id)
+     if not cart:
+         raise HTTPException(status_code=404, detail="购物车不存在")
+     return schemas.CartOut.model_validate(cart, from_attributes=True)
+ 
+ @router.post("/add", response_model=schemas.CartItemOut)
+ def add_to_cart(user_id: int, sku_id: int, quantity: int = 1, db: Session = Depends(get_db)):
+     cart_item = crud.add_to_cart(db, user_id, sku_id, quantity)
+     return schemas.CartItemOut.model_validate(cart_item, from_attributes=True)
+ 
+ @router.put("/update/{item_id}", response_model=schemas.CartItemOut)
+ def update_cart_item(user_id: int, item_id: int, quantity: int, db: Session = Depends(get_db)):
+     cart_item = crud.update_cart_item(db, user_id, item_id, quantity)
+     if not cart_item:
+         raise HTTPException(status_code=404, detail="购物车商品不存在")
+     return schemas.CartItemOut.model_validate(cart_item, from_attributes=True)
+ 
+ @router.delete("/remove/{item_id}")
+ def remove_from_cart(user_id: int, item_id: int, db: Session = Depends(get_db)):
+     success = crud.remove_from_cart(db, user_id, item_id)
+     if not success:
+         raise HTTPException(status_code=404, detail="购物车商品不存在")
+     return {"message": "商品已从购物车移除"}
+ 
+ @router.delete("/clear")
+ def clear_cart(user_id: int, db: Session = Depends(get_db)):
+     success = crud.clear_cart(db, user_id)
+     if not success:
+         raise HTTPException(status_code=404, detail="购物车不存在")
+     return {"message": "购物车已清空"} 
```

</details>

---

现在创建订单管理的API：


---

<details><summary>Edit file: enterprise-backend/app/api/endpoints/order.py</summary>

我将创建一个新的API端点文件来管理订单

**Chunk 1**
Lines added: 116, lines removed: 1

```diff
@@ -1,1 +1,116 @@
- 
+ from fastapi import APIRouter, Depends, HTTPException, Query
+ from sqlalchemy.orm import Session
+ from app import schemas, crud
+ from app.database import SessionLocal
+ from typing import List, Optional
+ 
+ router = APIRouter()
+ 
+ def get_db():
+     db = SessionLocal()
+     try:
+         yield db
+     finally:
+         db.close()
+ 
+ # 订单管理
+ @router.post("/", response_model=schemas.OrderOut)
+ def create_order(user_id: int, data: schemas.OrderCreate, db: Session = Depends(get_db)):
+     order = crud.create_order(db, user_id, data)
+     return schemas.OrderOut.model_validate(order, from_attributes=True)
+ 
+ @router.get("/user/{user_id}", response_model=schemas.OrderListResponse)
+ def get_user_orders(
+     user_id: int,
+     page: int = Query(1, ge=1, description="页码，从1开始"),
+     page_size: int = Query(10, ge=1, le=100, description="每页数量"),
+     db: Session = Depends(get_db)
+ ):
+     skip = (page - 1) * page_size
+     orders, total = crud.get_user_orders(db, user_id, skip=skip, limit=page_size)
+     total_pages = (total + page_size - 1) // page_size
+     
+     return schemas.OrderListResponse(
+         items=[schemas.OrderOut.model_validate(order, from_attributes=True) for order in orders],
+         total=total,
+         page=page,
+         page_size=page_size,
+         total_pages=total_pages
+     )
+ 
+ @router.get("/{order_id}", response_model=schemas.OrderOut)
+ def get_order(order_id: int, db: Session = Depends(get_db)):
+     order = crud.get_order(db, order_id)
+     if not order:
+         raise HTTPException(status_code=404, detail="订单不存在")
+     return schemas.OrderOut.model_validate(order, from_attributes=True)
+ 
+ @router.get("/no/{order_no}", response_model=schemas.OrderOut)
+ def get_order_by_no(order_no: str, db: Session = Depends(get_db)):
+     order = crud.get_order_by_no(db, order_no)
+     if not order:
+         raise HTTPException(status_code=404, detail="订单不存在")
+     return schemas.OrderOut.model_validate(order, from_attributes=True)
+ 
+ @router.put("/{order_id}", response_model=schemas.OrderOut)
+ def update_order(order_id: int, data: schemas.OrderUpdate, db: Session = Depends(get_db)):
+     order = crud.update_order(db, order_id, data)
+     if not order:
+         raise HTTPException(status_code=404, detail="订单不存在")
+     return schemas.OrderOut.model_validate(order, from_attributes=True)
+ 
+ # 管理员订单管理
+ @router.get("/admin/all", response_model=schemas.OrderListResponse)
+ def get_all_orders(
+     page: int = Query(1, ge=1, description="页码，从1开始"),
+     page_size: int = Query(10, ge=1, le=100, description="每页数量"),
+     status: Optional[str] = Query(None, description="订单状态筛选"),
+     db: Session = Depends(get_db)
+ ):
+     skip = (page - 1) * page_size
+     orders, total = crud.get_all_orders(db, skip=skip, limit=page_size, status=status)
+     total_pages = (total + page_size - 1) // page_size
+     
+     return schemas.OrderListResponse(
+         items=[schemas.OrderOut.model_validate(order, from_attributes=True) for order in orders],
+         total=total,
+         page=page,
+         page_size=page_size,
+         total_pages=total_pages
+     )
+ 
+ # 支付相关
+ @router.post("/{order_id}/pay", response_model=schemas.PaymentResponse)
+ def create_payment(order_id: int, payment_method: str, db: Session = Depends(get_db)):
+     order = crud.get_order(db, order_id)
+     if not order:
+         raise HTTPException(status_code=404, detail="订单不存在")
+     
+     if order.payment_status == "paid":
+         raise HTTPException(status_code=400, detail="订单已支付")
+     
+     # 这里应该集成真实的支付接口
+     # 目前返回模拟的支付信息
+     if payment_method == "wechat":
+         return schemas.PaymentResponse(
+             order_id=order_id,
+             payment_url="",
+             qr_code="模拟的微信支付二维码"
+         )
+     elif payment_method == "alipay":
+         return schemas.PaymentResponse(
+             order_id=order_id,
+             payment_url="模拟的支付宝支付链接",
+             qr_code=None
+         )
+     else:
+         raise HTTPException(status_code=400, detail="不支持的支付方式")
+ 
+ @router.post("/{order_id}/payment-callback")
+ def payment_callback(order_id: int, payment_status: str, db: Session = Depends(get_db)):
+     """支付回调接口"""
+     order = crud.update_payment_status(db, order_id, payment_status)
+     if not order:
+         raise HTTPException(status_code=404, detail="订单不存在")
+     
+     return {"message": "支付状态更新成功", "order_id": order_id, "status": payment_status} 
```

</details>

---

现在让我更新主API文件来包含新的路由：


---

Read file: enterprise-backend/app/api/__init__.py

---

<details><summary>Edit file: enterprise-backend/app/api/__init__.py</summary>

我将在现有路由基础上添加新的电商系统路由

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -1,4 +1,5 @@
  from fastapi import APIRouter
  from .endpoints import company, category, product, inquiry, user, upload, carousel, contact_message, service, client_product, client_user
+ from .endpoints import specification, sku, cart, order
  
  router = APIRouter()
```

**Chunk 2**
Lines added: 7, lines removed: 1

```diff
@@ -13,3 +14,9 @@
  router.include_router(service.router, prefix="/service", tags=["service"])
  router.include_router(client_product.router, prefix="/client-product", tags=["client-product"])
- router.include_router(client_user.router, prefix="/client-user", tags=["client-user"]) 
+ router.include_router(client_user.router, prefix="/client-user", tags=["client-user"])
+ 
+ # 电商系统相关路由
+ router.include_router(specification.router, prefix="/specification", tags=["specification"])
+ router.include_router(sku.router, prefix="/sku", tags=["sku"])
+ router.include_router(cart.router, prefix="/cart", tags=["cart"])
+ router.include_router(order.router, prefix="/order", tags=["order"]) 
```

</details>

---

现在让我更新现有的产品管理API来支持规格和SKU：


---

Read file: enterprise-backend/app/api/endpoints/product.py

---

现在让我更新产品管理API来支持规格和SKU的创建：


---

<details><summary>Edit file: enterprise-backend/app/api/endpoints/product.py</summary>

我将更新产品创建和更新API来支持规格和SKU的创建

**Chunk 1**
Lines added: 18, lines removed: 1

```diff
@@ -40,5 +40,22 @@
  def create_product(data: schemas.ProductCreate, db: Session = Depends(get_db)):
      try:
-         product = crud.create_product(db, data)
+         # 创建产品基本信息
+         product_data = data.dict(exclude={'specifications', 'skus'})
+         product = crud.create_product(db, schemas.ProductCreate(**product_data))
+         
+         # 创建产品规格
+         if data.specifications:
+             for spec_data in data.specifications:
+                 spec_data.product_id = product.id
+                 crud.create_product_specification(db, spec_data)
+         
+         # 创建产品SKU
+         if data.skus:
+             for sku_data in data.skus:
+                 sku_data.product_id = product.id
+                 crud.create_product_sku(db, sku_data)
+         
+         # 重新获取完整的产品信息
+         product = crud.get_product(db, product.id)
          return schemas.ProductOut.model_validate(product, from_attributes=True)
      except ValueError as e:
```

**Chunk 2**
Lines added: 17, lines removed: 1

```diff
@@ -50,12 +67,28 @@
      if not product:
          raise HTTPException(status_code=404, detail="Product not found")
+     
+     # 获取产品的规格和SKU信息
+     product.specifications = crud.get_product_specifications(db, product_id)
+     product.skus = crud.get_product_skus(db, product_id)
+     
      return schemas.ProductOut.model_validate(product, from_attributes=True)
  
  @router.put("/{product_id}", response_model=schemas.ProductOut)
  def update_product(product_id: int, data: schemas.ProductUpdate, db: Session = Depends(get_db)):
      try:
-         product = crud.update_product(db, product_id, data)
+         # 更新产品基本信息
+         product_data = data.dict(exclude={'specifications', 'skus'})
+         product = crud.update_product(db, product_id, schemas.ProductUpdate(**product_data))
          if not product:
              raise HTTPException(status_code=404, detail="Product not found")
+         
+         # 更新产品规格和SKU（这里简化处理，实际应该更复杂）
+         # 注意：这里只是示例，实际实现需要更复杂的逻辑来处理规格和SKU的更新
+         
+         # 重新获取完整的产品信息
+         product = crud.get_product(db, product_id)
+         product.specifications = crud.get_product_specifications(db, product_id)
+         product.skus = crud.get_product_skus(db, product_id)
+         
          return schemas.ProductOut.model_validate(product, from_attributes=True)
      except ValueError as e:
```

</details>

---



---

