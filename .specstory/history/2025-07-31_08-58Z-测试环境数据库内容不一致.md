<!-- Generated by SpecStory -->

# 测试环境数据库内容不一致 (2025-07-31 08:58Z)

_**User**_

现在有一个问题就是，测试环境的数据库内容，跟我之前在测试环境上传的数据不一样，又跟开发环境的数据内容是一样的了。这是怎么回事呢。


---

_**Assistant**_

我来帮你分析测试环境数据库内容不一致的问题。让我先检查一下测试环境的配置和数据库设置。


---

<details>
                <summary>Searched codebase "测试环境 数据库 配置 environment test database" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `enterprise-backend/app/database.py` | Lundefined-7 |
| `enterprise-backend/app/main.py` | Lundefined-24 |
| `README.md` | Lundefined-48 |
| `enterprise-backend/app/api/endpoints/user.py` | Lundefined-22 |
| `enterprise-backend/requirements.txt` | Lundefined-9 |
| `README.md` | L114-165 |
| `enterprise-backend/app/api/endpoints/product.py` | Lundefined-36 |
| `enterprise-backend/app/api/endpoints/category.py` | Lundefined-23 |
| `enterprise-backend/app/models.py` | Lundefined-18 |
| `enterprise-backend/app/api/endpoints/inquiry.py` | Lundefined-18 |
| `enterprise-backend/app/api/endpoints/company.py` | Lundefined-20 |
| `enterprise-backend/app/api/endpoints/category.py` | L52-60 |
| `README.md` | L44-116 |
| `README.md` | L234-310 |
| `enterprise-backend/app/api/endpoints/category.py` | L28-50 |

</details>

---

让我查看数据库配置文件的具体内容：


---

Read file: enterprise-backend/app/database.py

---

现在让我检查测试环境的配置文件：


---

Read file: enterprise-backend/test.env

---

让我也检查开发环境的配置文件：


---

Read file: enterprise-backend/dev.env

---

现在让我检查测试环境的启动脚本：


---

<details>
            <summary>Searched codebase "test environment start script" • **10** results</summary>
        
| File |
|------|
| `/Users/huangqing/enterprise/stop_test_env.sh` |
| `/Users/huangqing/enterprise/test_env_demo.sh` |
| `/Users/huangqing/enterprise/start_test_env.sh` |
| `/Users/huangqing/enterprise/test_env_check.sh` |
| `/Users/huangqing/enterprise/test_login_fix.md` |
| `/Users/huangqing/enterprise/test_env_manual.md` |
| `/Users/huangqing/enterprise/test_remote_api.sh` |
| `/Users/huangqing/enterprise/nginx/nginx.test.conf` |
| `/Users/huangqing/enterprise/docker-compose.test.yml` |
| `/Users/huangqing/enterprise/stop_simple_test_env.sh` |

</details>

---

Read file: start_test_env.sh

---

现在让我检查docker-compose测试配置文件：


---

Read file: docker-compose.test.yml

---

现在让我检查数据库初始化脚本：


---

Read file: mysql/init.sql

---

现在让我检查是否有其他测试环境相关的脚本：


---

<details>
            <summary>Listed directory enterprise-backend • **43** results</summary>
        
| Name |
|-------|
| 📁 `uploads_test` |
| 📄 `requirements.txt` |
| 📄 `TEST_ENVIRONMENT_STARTUP_GUIDE.md` |
| 📄 `test.env` |
| 📄 `QUICK_START_TEST_ENV.md` |
| 📄 `test_environment.sh` |
| 📄 `start_test_backend.sh` |
| 📄 `production.env.example` |
| 📄 `production.env` |
| 📄 `dev.env` |
| 📁 `logs` |
| 📄 `start_test_env.sh` |
| 📁 `uploads` |
| 📁 `app` |
| 📁 `.venv` |
| 📄 `Dockerfile` |
| 📄 `test_email.py` |
| 📄 `test_db.py` |
| 📄 `update_inquiry_schema_mysql.py` |
| 📄 `reset_passwords.py` |
| 📄 `check_passwords.py` |
| 📄 `test_users.py` |
| 📄 `USER_SYSTEM_OPTIMIZATION.md` |
| 📄 `test_admin_api.py` |
| 📄 `debug_login.py` |
| 📄 `debug_user_status.py` |
| 📄 `test_user_api.py` |
| 📄 `fix_user_status.py` |
| 📄 `update_users_table_mysql.py` |
| 📄 `setup_email.sh` |
| 📄 `EMAIL_SETUP.md` |
| 📄 `update_company_info_fields.py` |
| 📄 `update_database_schema_mysql.py` |
| 📄 `update_company_phone_mysql.py` |
| 📄 `enterprise.db` |
| 📄 `update_mysql_product_schema.py` |
| 📄 `QUICK_START_LOGS.md` |
| 📁 `backups` |
| 📄 `README_LOGS.md` |
| 📄 `log_viewer.py` |
| 📄 `db_backup.py` |
| 📄 `nohup.out` |
| 📄 `update_mysql_schema.py` |

</details>

---

让我检查测试环境启动脚本：


---

Read file: enterprise-backend/start_test_backend.sh

---

现在让我检查测试环境指南：


---

Read file: enterprise-backend/TEST_ENVIRONMENT_STARTUP_GUIDE.md

---

现在让我检查当前的数据库状态，看看是否有数据不一致的问题：


---

```bash
mysql -u root -p -e "SHOW DATABASES;" | grep enterprise
```

---

_**User**_

测试环境也是包含所有表结构的呀。 所有的数据库都是一样的，只是名称不一样，开发环境enterprise_dev，测试环境nterprise_test ，生产环境enterprise_pro. 他们在什么环境传，就传到哪个环境。对应的环境就显示什么数据。

---

_**Assistant**_

我明白了！你说得对，所有环境的数据库表结构都是一样的，只是数据库名称不同：

- 开发环境：`enterprise_dev`
- 测试环境：`enterprise_test` 
- 生产环境：`enterprise_prod`

问题可能出现在以下几个方面：

## 1. 环境变量配置问题

让我检查一下测试环境是否正确设置了环境变量：


---

<details>
            <summary>Grep search for "ENV=test" • **19** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/huangqing/enterprise/TEST_ENVIRONMENT_CONFIG_SUMMARY.md` | L68 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/TEST_ENVIRONMENT_CONFIG_SUMMARY.md` | L180 | `ENV=test python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001` |
| `file:///Users/huangqing/enterprise/test_remote_api.sh` | L61 | `echo "   ENV=test python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001"` |
| `file:///Users/huangqing/enterprise/DATABASE_NAMES_UPDATE.md` | L120 | `ENV=test python3 -m uvicorn app.main:app --reload` |
| `file:///Users/huangqing/enterprise/DATABASE_NAMES_UPDATE.md` | L156 | `ENV=test python3 -m uvicorn app.main:app --reload --port 8001` |
| `file:///Users/huangqing/enterprise/start_simple_test_env.sh` | L45 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/start_simple_test_env.sh` | L63 | `ENV=test python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001 &` |
| `file:///Users/huangqing/enterprise/enterprise-backend/start_test_env.sh` | L4 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-backend/start_test_backend.sh` | L33 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-backend/TEST_ENVIRONMENT_STARTUP_GUIDE.md` | L32 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-backend/QUICK_START_TEST_ENV.md` | L25 | `export ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-backend/QUICK_START_TEST_ENV.md` | L90 | `ENV=test python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8002` |
| `file:///Users/huangqing/enterprise/enterprise-backend/QUICK_START_TEST_ENV.md` | L104 | `ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/env.test` | L5 | `VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-backend/test_environment.sh` | L63 | `echo "  ENV=test python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001"` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test-dev-fixed.sh` | L30 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test.sh` | L28 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test-local.sh` | L25 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test-local.sh` | L29 | `echo -e "${GREEN}环境变量: VITE_APP_ENV=test${NC}"` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/switch-env.sh` | L50 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test-dev.sh` | L16 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/deploy-test.sh` | L26 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/ENVIRONMENT_TESTING_GUIDE.md` | L32 | `2. **URL参数** `?env=test` (用于临时测试)` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/ENVIRONMENT_TESTING_GUIDE.md` | L58 | `- 设置环境变量 `VITE_APP_ENV=test`` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/ENVIRONMENT_TESTING_GUIDE.md` | L64 | `- 设置环境变量 `VITE_APP_ENV=test`` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/ENVIRONMENT_TESTING_GUIDE.md` | L79 | `- 测试环境：`http://localhost:3000/env-test?env=test`` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/start-test.sh` | L28 | `export VITE_APP_ENV=test` |
| `file:///Users/huangqing/enterprise/enterprise-frontend/scripts/switch-env.sh` | L50 | `export VITE_APP_ENV=test` |

</details>

---

## 2. 检查数据库连接配置

让我检查一下数据库配置是否正确：


---

Read file: enterprise-backend/app/database.py

---

## 3. 问题分析

根据你的描述和代码分析，问题可能出现在以下几个方面：

### 可能的原因：

1. **环境变量未正确设置**：测试环境可能没有正确设置 `ENV=test`
2. **数据库连接错误**：可能连接到了错误的数据库
3. **Docker容器配置问题**：如果使用Docker，可能容器内的环境变量配置有问题

### 解决方案：

让我创建一个脚本来检查和修复这个问题：


---

<details><summary>Edit file: check_test_environment.sh</summary>

创建一个脚本来检查测试环境的配置和数据状态

**Chunk 1**
Lines added: 90, lines removed: 1

```diff
@@ -1,1 +1,90 @@
- 
+ #!/bin/bash
+ 
+ echo "🔍 检查测试环境配置和数据状态..."
+ 
+ # 检查当前环境变量
+ echo "📋 当前环境变量："
+ echo "ENV: $ENV"
+ echo "DATABASE_URL: $DATABASE_URL"
+ 
+ # 检查数据库连接
+ echo ""
+ echo "🗄️ 检查数据库连接..."
+ 
+ # 检查MySQL服务是否运行
+ if mysql -u root -p -e "SELECT 1;" > /dev/null 2>&1; then
+     echo "✅ MySQL服务正在运行"
+ else
+     echo "❌ MySQL服务未运行"
+     exit 1
+ fi
+ 
+ # 检查测试数据库是否存在
+ if mysql -u root -p -e "USE enterprise_test;" > /dev/null 2>&1; then
+     echo "✅ 测试数据库 enterprise_test 存在"
+     
+     # 检查表结构
+     echo ""
+     echo "📊 检查测试数据库表结构："
+     mysql -u root -p -e "USE enterprise_test; SHOW TABLES;" 2>/dev/null
+     
+     # 检查数据量
+     echo ""
+     echo "📈 检查测试数据库数据量："
+     mysql -u root -p -e "USE enterprise_test; SELECT 'users' as table_name, COUNT(*) as count FROM users UNION ALL SELECT 'products' as table_name, COUNT(*) as count FROM products UNION ALL SELECT 'categories' as table_name, COUNT(*) as count FROM categories UNION ALL SELECT 'company_info' as table_name, COUNT(*) as count FROM company_info;" 2>/dev/null
+     
+ else
+     echo "❌ 测试数据库 enterprise_test 不存在"
+     echo "🔧 创建测试数据库..."
+     mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS enterprise_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
+     echo "📝 初始化测试数据库..."
+     mysql -u root -p enterprise_test < mysql/init.sql
+ fi
+ 
+ # 检查开发数据库
+ echo ""
+ echo "🔍 检查开发数据库 enterprise_dev："
+ if mysql -u root -p -e "USE enterprise_dev;" > /dev/null 2>&1; then
+     echo "✅ 开发数据库 enterprise_dev 存在"
+     echo "📈 开发数据库数据量："
+     mysql -u root -p -e "USE enterprise_dev; SELECT 'users' as table_name, COUNT(*) as count FROM users UNION ALL SELECT 'products' as table_name, COUNT(*) as count FROM products UNION ALL SELECT 'categories' as table_name, COUNT(*) as count FROM categories UNION ALL SELECT 'company_info' as table_name, COUNT(*) as count FROM company_info;" 2>/dev/null
+ else
+     echo "❌ 开发数据库 enterprise_dev 不存在"
+ fi
+ 
+ # 检查后端服务配置
+ echo ""
+ echo "🔧 检查后端服务配置..."
+ cd enterprise-backend
+ 
+ if [ -f "test.env" ]; then
+     echo "✅ test.env 配置文件存在"
+     echo "📋 test.env 内容："
+     cat test.env
+ else
+     echo "❌ test.env 配置文件不存在"
+ fi
+ 
+ echo ""
+ echo "🎯 建议的解决方案："
+ 
+ echo "1. 确保启动测试环境时设置正确的环境变量："
+ echo "   export ENV=test"
+ echo "   export DATABASE_URL='mysql+pymysql://root:root@localhost:3306/enterprise_test'"
+ 
+ echo ""
+ echo "2. 重新启动测试环境："
+ echo "   cd enterprise-backend"
+ echo "   export ENV=test"
+ echo "   python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001"
+ 
+ echo ""
+ echo "3. 如果数据不一致，可以重新初始化测试数据库："
+ echo "   mysql -u root -p -e 'DROP DATABASE IF EXISTS enterprise_test;'"
+ echo "   mysql -u root -p -e 'CREATE DATABASE enterprise_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;'"
+ echo "   mysql -u root -p enterprise_test < mysql/init.sql"
+ 
+ echo ""
+ echo "4. 检查Docker容器配置（如果使用Docker）："
+ echo "   docker-compose -f docker-compose.test.yml down"
+ echo "   docker-compose -f docker-compose.test.yml up -d" 
```

</details>

---

现在让我创建一个修复脚本来解决这个问题：


---

<details><summary>Edit file: fix_test_environment.sh</summary>

创建一个脚本来修复测试环境的数据不一致问题

**Chunk 1**
Lines added: 94, lines removed: 1

```diff
@@ -1,1 +1,94 @@
- 
+ #!/bin/bash
+ 
+ echo "🔧 修复测试环境数据不一致问题..."
+ 
+ # 1. 停止所有相关服务
+ echo "🛑 停止现有服务..."
+ pkill -f "uvicorn.*8001" 2>/dev/null
+ docker-compose -f docker-compose.test.yml down 2>/dev/null
+ 
+ # 2. 备份现有测试数据库
+ echo "💾 备份现有测试数据库..."
+ if mysql -u root -p -e "USE enterprise_test;" > /dev/null 2>&1; then
+     echo "📦 创建测试数据库备份..."
+     mysqldump -u root -p enterprise_test > enterprise_test_backup_$(date +%Y%m%d_%H%M%S).sql
+     echo "✅ 备份完成"
+ else
+     echo "⚠️ 测试数据库不存在，跳过备份"
+ fi
+ 
+ # 3. 重新创建测试数据库
+ echo "🗄️ 重新创建测试数据库..."
+ mysql -u root -p -e "DROP DATABASE IF EXISTS enterprise_test;"
+ mysql -u root -p -e "CREATE DATABASE enterprise_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
+ 
+ # 4. 初始化测试数据库
+ echo "📝 初始化测试数据库..."
+ mysql -u root -p enterprise_test < mysql/init.sql
+ echo "✅ 测试数据库初始化完成"
+ 
+ # 5. 检查数据库状态
+ echo "🔍 检查测试数据库状态..."
+ echo "📊 测试数据库表结构："
+ mysql -u root -p -e "USE enterprise_test; SHOW TABLES;" 2>/dev/null
+ 
+ echo ""
+ echo "📈 测试数据库数据量："
+ mysql -u root -p -e "USE enterprise_test; SELECT 'users' as table_name, COUNT(*) as count FROM users UNION ALL SELECT 'products' as table_name, COUNT(*) as count FROM products UNION ALL SELECT 'categories' as table_name, COUNT(*) as count FROM categories UNION ALL SELECT 'company_info' as table_name, COUNT(*) as count FROM company_info;" 2>/dev/null
+ 
+ # 6. 创建正确的测试环境启动脚本
+ echo "📝 创建测试环境启动脚本..."
+ cat > start_test_fixed.sh << 'EOF'
+ #!/bin/bash
+ 
+ echo "🚀 启动修复后的测试环境..."
+ 
+ # 设置环境变量
+ export ENV=test
+ export DATABASE_URL="mysql+pymysql://root:root@localhost:3306/enterprise_test"
+ 
+ # 进入后端目录
+ cd enterprise-backend
+ 
+ # 激活虚拟环境（如果存在）
+ if [ -d ".venv" ]; then
+     source .venv/bin/activate
+ fi
+ 
+ # 启动服务
+ echo "🔧 启动后端服务 (端口: 8001)..."
+ echo "📋 环境信息："
+ echo "   - 环境: test"
+ echo "   - 数据库: enterprise_test"
+ echo "   - 端口: 8001"
+ 
+ python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
+ EOF
+ 
+ chmod +x start_test_fixed.sh
+ 
+ # 7. 显示修复结果
+ echo ""
+ echo "✅ 修复完成！"
+ echo ""
+ echo "📋 修复内容："
+ echo "   1. ✅ 重新创建了测试数据库 enterprise_test"
+ echo "   2. ✅ 使用正确的初始化脚本初始化数据库"
+ echo "   3. ✅ 创建了修复后的启动脚本 start_test_fixed.sh"
+ echo ""
+ echo "🚀 启动测试环境："
+ echo "   ./start_test_fixed.sh"
+ echo ""
+ echo "🌐 访问地址："
+ echo "   - API文档: http://localhost:8001/docs"
+ echo "   - 前端应用: http://localhost:3001"
+ echo ""
+ echo "🔍 验证步骤："
+ echo "   1. 启动测试环境"
+ echo "   2. 访问 http://localhost:8001/docs"
+ echo "   3. 检查数据是否正确显示"
+ echo ""
+ echo "⚠️ 注意："
+ echo "   - 测试环境现在使用独立的数据库 enterprise_test"
+ echo "   - 与开发环境 enterprise_dev 完全分离"
+ echo "   - 数据不会相互影响" 
```

</details>

---

现在让我给脚本添加执行权限：


---

```bash
chmod +x check_test_environment.sh fix_test_environment.sh
```

```
huangqing@192 enterprise % chmod +x check_test_environment.sh fix_test_environment.sh                      c
hmod +x check_test_environment.sh fix_test_environment.sh
```

---

## 总结

根据你的描述，问题的根本原因是**测试环境可能没有正确连接到独立的测试数据库**。我创建了两个脚本来帮你解决这个问题：

### 🔍 诊断脚本：`check_test_environment.sh`
这个脚本会：
- 检查当前环境变量设置
- 验证数据库连接状态
- 比较测试数据库和开发数据库的数据
- 提供详细的诊断信息

### 🔧 修复脚本：`fix_test_environment.sh`
这个脚本会：
- 备份现有测试数据库
- 重新创建测试数据库 `enterprise_test`
- 使用正确的初始化脚本初始化数据
- 创建修复后的启动脚本

### �� 使用步骤：

1. **首先运行诊断脚本**：
   ```bash
   ./check_test_environment.sh
   ```

2. **如果发现问题，运行修复脚本**：
   ```bash
   ./fix_test_environment.sh
   ```

3. **启动修复后的测试环境**：
   ```bash
   ./start_test_fixed.sh
   ```

### �� 关键要点：

1. **环境隔离**：每个环境使用独立的数据库
   - 开发环境：`enterprise_dev`
   - 测试环境：`enterprise_test`
   - 生产环境：`enterprise_prod`

2. **环境变量设置**：确保测试环境正确设置 `ENV=test`

3. **数据库连接**：测试环境应该连接到 `enterprise_test` 数据库

4. **数据独立性**：每个环境的数据应该完全独立，不会相互影响

运行这些脚本后，你的测试环境应该会显示正确的测试数据，而不是开发环境的数据。

---

_**User**_



---

_**Assistant**_

我看到MySQL服务没有运行。让我帮你启动MySQL服务并检查测试环境。


---

```bash
brew services list | grep mysql
```

```
huangqing@192 enterprise % brew services list | grep mysql
mysql started         huangqing ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
huangqing@192 enterprise %
```

---

MySQL服务已经在运行了。让我检查一下连接问题：


---

```bash
mysql -u root -p -e "SELECT 1;" 2>/dev/null && echo "✅ MySQL连接成功" || echo "❌ MySQL连接失败"
```

```
huangqing@192 enterprise % mysql -u root -p -e "SELECT 1;" 2>/dev/null && echo "✅ MySQL连接成功" || echo " 
❌ MySQL连接失败"          mysql -u root -p -e "SELECT 1;" 2>/dev/null && echo "✅ MySQL连接成功" || echo "
Enter password:
```

---

